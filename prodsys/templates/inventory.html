<script>
// ====================== CONFIG ======================
const apiUrl = "{{ inventory_api_url }}";

// ====================== TOKEN HANDLING ======================
let accessToken = localStorage.getItem("accessToken") || "{{ request.COOKIES.access|default:'' }}";
let refreshToken = localStorage.getItem("refreshToken") || "{{ request.COOKIES.refresh|default:'' }}";

function redirectToLogin() {
  alert("You must login first!");
  window.location.href = "/login/";
}

if (!accessToken) redirectToLogin();

// Parse JWT to extract role
function parseJwt(token) {
  try { return JSON.parse(atob(token.split('.')[1])); } 
  catch (e) { return {}; }
}

let jwtPayload = parseJwt(accessToken);
let role = jwtPayload.role ? jwtPayload.role.toUpperCase() : "{{ role|upper }}";
document.getElementById("userRole").innerText = role;

// Role permissions
const canEdit = ["MANAGER", "ADMIN"].includes(role);
const canDelete = role === "ADMIN";

// ====================== STATE ======================
let items = [];
let currentAction = "edit";

// ====================== LOAD INVENTORY ======================
async function loadInventory() {
  if (!accessToken) return redirectToLogin();
  try {
    const res = await fetch(apiUrl, {
      headers: { "Authorization": `Bearer ${accessToken}` }
    });
    if (res.status === 401) return redirectToLogin();
    if (!res.ok) throw new Error("Failed to fetch inventory");
    items = await res.json();
    renderTable();
  } catch (err) {
    console.error(err);
    alert(err.message);
  }
}

// ====================== RENDER TABLE ======================
function renderTable() {
  const tbody = document.querySelector("#inventory-table tbody");
  tbody.innerHTML = "";

  items.forEach(item => {
    const actions = [];
    if (canEdit) {
      actions.push(`<button onclick="openModal('edit', ${item.id})" class="bg-yellow-500 px-2 py-1 text-white rounded">Edit</button>`);
      actions.push(`<button onclick="openModal('stock_in', ${item.id})" class="bg-green-500 px-2 py-1 text-white rounded ml-1">Stock In</button>`);
      actions.push(`<button onclick="openModal('stock_out', ${item.id})" class="bg-red-500 px-2 py-1 text-white rounded ml-1">Stock Out</button>`);
    }
    if (canDelete) {
      actions.push(`<button onclick="deleteItem(${item.id})" class="bg-gray-800 px-2 py-1 text-white rounded ml-1">Delete</button>`);
    }

    tbody.innerHTML += `
      <tr>
        <td class="border px-4 py-2">${item.name}</td>
        <td class="border px-4 py-2">${item.quantity}</td>
        <td class="border px-4 py-2">${item.unit}</td>
        <td class="border px-4 py-2">${actions.join("")}</td>
      </tr>
    `;
  });
}

// ====================== MODAL ======================
function openModal(action, id) {
  currentAction = action;
  const item = items.find(i => i.id === id);

  document.getElementById("itemId").value = item.id;
  document.getElementById("itemName").value = item.name;
  document.getElementById("itemQuantity").value = action === "edit" ? item.quantity : 0;
  document.getElementById("itemUnit").value = item.unit;

  const titleMap = { edit: "Edit Item", stock_in: "Stock In", stock_out: "Stock Out" };
  document.getElementById("modalTitle").innerText = titleMap[action] || "Edit Item";
  document.getElementById("modalSubmit").innerText = action === "edit" ? "Save" : "Submit";

  document.getElementById("stockModal").classList.remove("hidden");
}

function closeModal() {
  document.getElementById("stockModal").classList.add("hidden");
}

// ====================== FORM SUBMISSION ======================
document.getElementById("stockForm").addEventListener("submit", async (e) => {
  e.preventDefault();
  const id = document.getElementById("itemId").value;
  const qty = parseFloat(document.getElementById("itemQuantity").value);
  if (isNaN(qty) || qty < 0) return alert("Quantity must be >= 0");

  let method = "PUT";
  let endpoint = `${apiUrl}${id}/`;
  let bodyData = {};

  if (currentAction === "edit") {
    bodyData = { quantity: qty, unit: document.getElementById("itemUnit").value };
  } else if (currentAction === "stock_in") {
    method = "POST";
    endpoint += "stock_in/";
    bodyData = { quantity: qty };
  } else if (currentAction === "stock_out") {
    method = "POST";
    endpoint += "stock_out/";
    bodyData = { quantity: qty };
  }

  try {
    const res = await fetch(endpoint, {
      method,
      headers: { "Content-Type": "application/json", "Authorization": `Bearer ${accessToken}` },
      body: JSON.stringify(bodyData)
    });
    if (!res.ok) throw new Error(await res.text());
    closeModal();
    loadInventory();
    alert("Action completed successfully!");
  } catch (err) {
    console.error(err);
    alert("Action failed: " + err.message);
  }
});

// ====================== DELETE ======================
async function deleteItem(id) {
  if (!confirm("Are you sure you want to delete this item?")) return;
  try {
    const res = await fetch(`${apiUrl}${id}/`, {
      method: "DELETE",
      headers: { "Authorization": `Bearer ${accessToken}` }
    });
    if (!res.ok) throw new Error(await res.text());
    loadInventory();
    alert("Item deleted successfully!");
  } catch (err) {
    console.error(err);
    alert("Delete failed: " + err.message);
  }
}

// ====================== INIT ======================
document.addEventListener("DOMContentLoaded", loadInventory);
</script>
