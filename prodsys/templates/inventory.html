{% extends "base.html" %}
{% load static %}

{% block content %}
  <h1 class="text-xl font-bold mb-4">Inventory</h1>

  <p class="mb-2">Logged in as: <strong>{{ role }}</strong></p>

  <table class="table-auto border-collapse border border-gray-400 w-full" id="inventory-table">
    <thead>
      <tr>
        <th class="border px-4 py-2">Item</th>
        <th class="border px-4 py-2">Quantity</th>
        <th class="border px-4 py-2">Unit</th>
        <th class="border px-4 py-2">Actions</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>

  <!-- Simple modal for editing -->
  <div id="editModal" class="hidden fixed inset-0 bg-gray-900 bg-opacity-50 flex justify-center items-center">
    <div class="bg-white p-6 rounded-lg shadow-lg w-96">
      <h2 class="text-lg font-bold mb-4">Edit Item</h2>
      <form id="editForm">
        <input type="hidden" id="editId">
        <label class="block mb-2">Name</label>
        <input type="text" id="editName" class="border p-2 w-full mb-2" readonly>
        
        <label class="block mb-2">Quantity</label>
        <input type="number" id="editQuantity" class="border p-2 w-full mb-2">

        <label class="block mb-2">Unit</label>
        <input type="text" id="editUnit" class="border p-2 w-full mb-4">

        <div class="flex justify-end space-x-2">
          <button type="button" onclick="closeModal()" class="bg-gray-400 px-4 py-2 rounded">Cancel</button>
          <button type="submit" class="bg-blue-600 text-white px-4 py-2 rounded">Save</button>
        </div>
      </form>
    </div>
  </div>

  <script>
    const apiUrl = "{{ inventory_api_url }}";
    const role = "{{ role }}";
    let items = [];

    async function loadInventory() {
      try {
        const response = await fetch(apiUrl, {
          headers: { "Authorization": "Bearer {{ request.COOKIES.access|default:'' }}" }
        });
        items = await response.json();
        renderTable();
      } catch (error) {
        alert("Error loading inventory");
        console.error(error);
      }
    }

    function renderTable() {
      const tbody = document.querySelector("#inventory-table tbody");
      tbody.innerHTML = "";
      items.forEach(item => {
        const row = document.createElement("tr");
        row.innerHTML = `
          <td class="border px-4 py-2">${item.name}</td>
          <td class="border px-4 py-2">${item.quantity}</td>
          <td class="border px-4 py-2">${item.unit}</td>
          <td class="border px-4 py-2">
            ${(role === "Manager" || role === "Admin") ? `<button onclick="openEdit(${item.id})" class="bg-yellow-500 px-2 py-1 text-white rounded">Edit</button>` : ""}
            ${role === "Admin" ? `<button onclick="deleteItem(${item.id})" class="bg-red-600 px-2 py-1 text-white rounded ml-2">Delete</button>` : ""}
          </td>
        `;
        tbody.appendChild(row);
      });
    }

    function openEdit(id) {
      const item = items.find(i => i.id === id);
      document.getElementById("editId").value = item.id;
      document.getElementById("editName").value = item.name;
      document.getElementById("editQuantity").value = item.quantity;
      document.getElementById("editUnit").value = item.unit;
      document.getElementById("editModal").classList.remove("hidden");
    }

    function closeModal() {
      document.getElementById("editModal").classList.add("hidden");
    }

    document.getElementById("editForm").addEventListener("submit", async (e) => {
      e.preventDefault();
      const id = document.getElementById("editId").value;
      const quantity = document.getElementById("editQuantity").value;
      const unit = document.getElementById("editUnit").value;

      try {
        await fetch(`${apiUrl}${id}/`, {
          method: "PUT",
          headers: {
            "Content-Type": "application/json",
            "Authorization": "Bearer {{ request.COOKIES.access|default:'' }}"
          },
          body: JSON.stringify({ quantity, unit })
        });
        closeModal();
        loadInventory();
      } catch (error) {
        alert("Failed to update item");
        console.error(error);
      }
    });

    async function deleteItem(id) {
      if (!confirm("Are you sure you want to delete this item?")) return;
      try {
        await fetch(`${apiUrl}${id}/`, {
          method: "DELETE",
          headers: { "Authorization": "Bearer {{ request.COOKIES.access|default:'' }}" }
        });
        loadInventory();
      } catch (error) {
        alert("Failed to delete item");
        console.error(error);
      }
    }

    document.addEventListener("DOMContentLoaded", loadInventory);
  </script>
{% endblock %}
